# {{PROJECT_NAME}} -- Development Instructions

This document defines coding standards, workflows, and conventions for {{PROJECT_NAME}}.

**Stack:** Go 1.25+ (Chi, sqlc, goose) + Next.js 16 (React 19, TypeScript, shadcn/ui, TanStack Query) + PostgreSQL 16+

---

## Project Structure

```
{{PROJECT_NAME}}/
  cmd/
    server/main.go             -- Go entry point
    admin/                     -- CLI admin tool
  internal/
    config/                    -- Env-based configuration
    server/                    -- HTTP server setup, routes
    handler/                   -- HTTP handlers by domain
    domain/                    -- Pure business logic (no HTTP, no DB)
    store/
      queries/                 -- Raw SQL for sqlc input
      sqlc/                    -- Generated Go code (DO NOT EDIT)
      migrations/              -- goose SQL migrations
    email/                     -- Email provider abstraction
    session/                   -- Session management helpers
    storage/                   -- Object storage abstraction (S3-compatible)
    middleware/                -- Auth, org context, rate limiting
    worker/                    -- Background job processing
  ee/                          -- Enterprise features (build-tag gated)
  web/                         -- Next.js frontend
    src/app/                   -- App Router pages
    src/components/            -- UI components
    src/lib/                   -- API client, types, validators
    src/hooks/                 -- Custom React hooks
  .plans/                      -- Implementation plans (generated by /plan)
  docker/                      -- Dockerfiles and compose
```

## Critical Rules

### Do NOT Edit Generated Files
- `internal/store/sqlc/` -- Generated by sqlc. Edit `internal/store/queries/*.sql` instead, then run `sqlc generate`.
- `web/src/components/ui/` -- shadcn/ui components. Modify via shadcn CLI, not by hand.

### sqlc Code Generation
- After modifying any `.sql` file in `internal/store/queries/`, regenerate code immediately with `sqlc generate`
- Alternative: `make generate`

### Multi-Tenancy
- ALWAYS derive `organization_id` from the session context, NEVER from the request body.
- Every database query on tenant data MUST filter by `organization_id`.
- PostgreSQL RLS is defense-in-depth, not a replacement for application-level filtering.

### Enterprise Code
- Enterprise features live in `/ee` and are excluded from OSS builds via Go build tags.
- `go build -tags enterprise` includes `/ee`. Default build excludes it.
- Never import `/ee` packages from `/internal`.

### Worktrees: Always Work Inside Them
When using `/worktree create <name>` to create a git worktree:
- **IMMEDIATELY switch your working directory** to `.worktrees/<name>/` after creation.
- Use `workdir` parameter on ALL Bash tool calls.
- Use absolute paths for ALL file operations.
- **NEVER** continue editing files in the main repo directory after creating a worktree.
- Before committing, verify: `git branch --show-current` should show the feature branch, not `main`.

---

## Go Backend Conventions

### Imports — three groups, separated by blank lines
```go
import (
    "context"                        // 1. stdlib
    "fmt"

    "github.com/go-chi/chi/v5"      // 2. third-party

    "{{PROJECT_NAME}}/internal/domain"    // 3. internal
    "{{PROJECT_NAME}}/internal/middleware"
)
```

### Error Handling
```go
// ALWAYS wrap errors with context
return fmt.Errorf("get item %s: %w", id, err)

// ALWAYS use errors.Is/As for checking
if errors.Is(err, sql.ErrNoRows) { ... }

// NEVER ignore errors with _
result, _ := doSomething()  // BAD
```

### HTTP Handlers
```go
// Handlers go in internal/handler/, organized by domain
// Use Chi router, accept context from middleware
func (h *Handler) GetItem(w http.ResponseWriter, r *http.Request) {
    orgID := middleware.OrgID(r.Context())  // From session, never request body
    id := chi.URLParam(r, "id")
    // ...
}
```

### Database Queries (sqlc)
- Write SQL in `internal/store/queries/*.sql`
- Run `sqlc generate` to produce Go code
- NEVER write raw SQL in handler or domain code
- ALWAYS use parameterized queries (sqlc enforces this)

### Background Jobs
- Postgres `jobs` table with `FOR UPDATE SKIP LOCKED` (no Redis, no external library)
- Enqueue by inserting a row into the `jobs` table
- `internal/worker/` package: `Worker` (polling loop, concurrency, graceful shutdown)
- Register handlers via `w.Register(kind, handlerFunc)` before calling `w.Run(ctx)`

### Logging
```go
// Use zerolog, structured JSON
log.Info().Str("item_id", id).Msg("item created")
log.Error().Err(err).Str("handler", "GetItem").Msg("failed to fetch item")
```

### Naming
- Packages: lowercase, no underscores (`handler`, `store`, `domain`)
- Interfaces: `-er` suffix when appropriate (`Provider`, `Sender`)
- Errors: `Err` prefix (`ErrNotFound`, `ErrUnauthorized`)
- Context first parameter: `func Do(ctx context.Context, ...)`

### Testing — table-driven, parallel, interface mocks
```go
func TestFoo(t *testing.T) {
    t.Parallel()
    tests := []struct {
        name       string
        // ...
        wantStatus int
    }{ /* cases */ }
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            t.Parallel()
            // use mock interfaces
        })
    }
}
```
- `t.Parallel()` is required on both top-level tests and subtests.
- Mocks are hand-written via interfaces.
- `//nolint` directives require an explanation and specific linter name.

---

## Frontend Conventions (Next.js / TypeScript)

### Rendering Strategy
| Audience | Route Group | Rendering |
|----------|-------------|-----------|
| Public | `/(public)/*` | SSR |
| External users | `/(external)/*` | SSR + Client |
| Team Dashboard | `/(dashboard)/*` | Client (SPA) |

### State Management
- Server state: TanStack Query with `queryOptions()` factories in `web/src/lib/queries/`.
- Form state: react-hook-form + zod validation.
- NO global state library (no Redux, Zustand, etc.).

### API Client
```typescript
// web/src/lib/api.ts -- typed fetch wrapper
// All API calls go through this client
// Credentials: 'include' for session cookies
// Base: /api/v1/
```

### TypeScript
- Strict mode, no `any` types.
- Zod schemas for runtime validation.
- Types mirror Go structs in `web/src/lib/types.ts`.
- Path alias: `@/` maps to `src/`.
- Unused vars: prefix with `_`.

### Styling
- Tailwind CSS 4 utility classes.
- shadcn/ui for all standard components (do not hand-edit `components/ui/`).
- No CSS modules, no styled-components.

### Testing — Vitest + React Testing Library
- Test files: `*.test.ts` / `*.test.tsx` colocated with source.
- E2E: Playwright in `web/tests/e2e/`.

---

## Security Checklist (Before ANY commit)

- [ ] No hardcoded secrets (API keys, passwords, tokens)
- [ ] All user inputs validated (Go: domain validation, Frontend: `zod`)
- [ ] SQL injection prevention (sqlc parameterized queries ONLY)
- [ ] XSS prevention (HTML sanitization for user content, React escaping, CSP headers)
- [ ] CSRF protection (SameSite cookies + CSRF token header)
- [ ] Authentication verified on protected routes
- [ ] Authorization checked (RBAC via `domain.HasPermission()`)
- [ ] Rate limiting on public endpoints (httprate)
- [ ] File uploads validated (type, size, no executables)
- [ ] Error messages don't leak internal details
- [ ] `organization_id` derived from session, not request body

---

## Git Workflow

### Commit Message Format
```
<type>(<scope>): <description>

Types: feat, fix, refactor, docs, test, chore, perf, ci
Scopes: api, web, db, auth, email, worker, docker
```

---

## Build & Dev Commands

```bash
# Development
make dev                    # Start dev environment via Docker Compose
make fullstack              # Start full stack including backend + frontend

# Build
make build                  # Build Go binary
make build-enterprise       # Build with enterprise features
make build-docker           # Build production Docker image

# Test
make test                   # Go tests with race detector
make test-cover             # Go tests with coverage
make test-web               # Frontend tests

# Lint
make lint                   # golangci-lint + ESLint

# Database
make migrate                # Run goose migrations up
make migrate-down           # Roll back one migration
make migrate-status         # Show migration status
make migrate-create         # Create a new migration file
make generate               # Run sqlc code generation

# Go commands
go build ./...                                          # compile all packages
go build -o bin/server ./cmd/server                     # build server binary
golangci-lint run                                       # lint
go test ./... -race -count=1                            # run all tests
go test -race ./internal/handler/...                    # run tests for one package
go test -race -run TestFoo ./internal/handler/...       # run a single test

# Frontend commands (from web/)
npm run build          # production build
npx eslint .           # lint
npx vitest run         # run all tests
npx vitest             # watch mode
```

---

## Performance Guidelines

### Go Backend
- Connection pooling: pgx pool (20 max, 5 min connections)
- No N+1 queries (use JOINs or batch queries via sqlc)
- Background jobs for async work (email, webhooks)
- Single static binary deployment

### Frontend
- SSR for public pages (SEO, speed)
- SPA for authenticated dashboard (rich interactivity)
- TanStack Query for server state caching
- Dynamic imports for code splitting
- Next.js Image component for optimized images

### Database
- Index all foreign keys and WHERE/JOIN columns
- Composite indexes: equality columns first, then range
- Full-text search via tsvector (no external search engine)
- Offset-based pagination for MVP (cursor-based for scale)

---

## Agent Usage Guide

| Situation | Agent / Command |
|-----------|-----------------|
| Planning a new feature | `/plan` |
| Go code review | `/go-review` |
| General code review | `/code-review` |
| Security review | `/security` |
| Go build errors | `/go-build` |
| Frontend build errors | `/build-fix` |
| TDD workflow | `/tdd` or `/go-test` |
| Database schema/queries | `/db-review` |
| E2E testing | `/e2e` |
| Dead code cleanup | `/refactor-clean` |
| Documentation | `/update-docs` |
| Project status overview | `/status` |
| Database migrations | `/migrate` |
| Cross-stack orchestration | `/orchestrate` |
| Test coverage analysis | `/test-coverage` |
| Session notes / handoff | `/session-notes` |
| Mid-session learning | `/learn` |
| View learned patterns | `/instinct-status` |
| Competitive graded review | `/review-battle` |
| Cluster patterns into skills | `/evolve` |
| Parallel multi-agent worktrees | `/worktree` |
| Comprehensive verification | `/verify` |
| Workflow checkpoints | `/checkpoint` |
